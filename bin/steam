#!/usr/bin/perl

use strict;
use warnings;
#use diagnostics;
use Data::Dumper;
use DateTime;
use LifeGraphs;
#use Readonly;

# verify data directory
my $data_dir = $ENV{STATS_DIR};
die "no STATS_DIR defined" unless defined $data_dir;
die "$data_dir is not a directory" unless -d $data_dir;
chdir($data_dir) or die "somehow failed to chdir($data_dir): $!";

# retrieve existing data
my $steam_storable_filename = 'steam.storable';
my $steam_json_filename = 'steam.json';
my $data_out = get_storable("$data_dir/$steam_storable_filename");

#
# get content: steam profile
#
my $profile_url = 'http://steamcommunity.com/profiles/76561198037662755';
my $tree = url_tree($profile_url);

my $stats_time = DateTime->now->format_cldr("yyyy-MM-dd HH:mm");

#
# get right column data
#
my $item_links_div = $tree->look_down(
		'_tag' => 'div',
		'class' => 'profile_item_links',
);
my @rows = $item_links_div->look_down(
		'_tag' => 'div',
		'class' => 'profile_count_link',
);
foreach my $row (@rows) {
	my $textified = $row->as_text;
	$textified = trim($textified);
	my ($label,$value) = split( /\s+/, $textified);
	next unless defined $value;
	#print "## $label => $value\n";
	
	$data_out->{$stats_time}->{$label} = $value;
}

#
# get recent game activity summary
#
my $rga_div = $tree->look_down(
		'_tag' => 'div',
		'class' => 'recentgame_quicklinks',
);

my $rga_text = trim($rga_div->as_text);
$data_out->{$stats_time}->{'recent_game_activity'} = $rga_text;

#
# get recent game activity details
#

@rows = $tree->look_down(
		'_tag' => 'div',
		'class' => 'recent_game',
);

foreach my $row (@rows) {
	my $game_name_div = $row->look_down('_tag' => 'div', 'class' => 'game_name');
	my $game_name = $game_name_div->as_text;

	my @recent_achievements = $row->look_down('_tag' => 'div', 'class' => 'game_info_achievement');
	my @recent_achievements_text = map { $_->attr('title') } @recent_achievements;
	next unless scalar @recent_achievements_text;
	$data_out->{$stats_time}->{'game_details'}->{$game_name}->{'recent_achievements'} = [@recent_achievements_text];

	my $achievement_progress_div = $row->look_down('_tag' => 'span', 'class' => 'game_info_achievement_summary');
	my $achievement_progress = $achievement_progress_div->as_text;
	if ($achievement_progress =~ /(\d+) of (\d+)/) {
		$data_out->{$stats_time}->{'game_details'}->{$game_name}->{'achievements_current'} = $1;
		$data_out->{$stats_time}->{'game_details'}->{$game_name}->{'achievements_total'} = $2;
	} else {
		print "$game_name $achievement_progress\n";
	}
}

#
# get showcase stats
#
@rows = $tree->look_down(
		'_tag' => 'div',
		'class' => 'showcase_content_bg showcase_stats_row',
);
foreach my $row (@rows) {
	my (@kv_pairs) = $row->look_down('_tag' => 'div', 'class' => 'value');
	foreach my $pair (@kv_pairs) {
		my $label = $pair->right();
		my $label_text = trim($label->as_text);
		my $value_text = trim($pair->as_text);
	#	print "$label_text => $value_text\n";
		$data_out->{$stats_time}->{$label_text} = $value_text;
	}
}

#
# get overall game details
#

my $games_url = 'http://steamcommunity.com/profiles/76561198037662755/games?tab=all';
$tree = url_tree($games_url);

@rows = $tree->look_down(
		'_tag' => 'script',
);
foreach my $row (@rows) {
	my $js = $row->as_HTML;
	if ($js =~ /var rgGames = ([^;]+);/) {
		my $raw_json = $1;
		my $json = JSON->new->allow_nonref; # no html fiddling, brilliant!
		my $games = $json->decode($raw_json);
#		print Dumper($games);
		foreach my $game (@$games) {
			my $game_name = $game->{'name'};

			my $hours_forever = $game->{'hours_forever'};
			if ( defined $hours_forever ) {
				$data_out->{$stats_time}->{'game_details'}->{$game_name}->{'hrs_total'} = $hours_forever;
				#print "$hours_forever hrs in $game_name\n";
			}

			my $last_played = $game->{'last_played'};
			if ( defined $last_played ) {
				$data_out->{$stats_time}->{'game_details'}->{$game_name}->{'last_played'} = $last_played;
				#my $when = DateTime->from_epoch(epoch => $last_played);
				#print "$when $game_name\n";
			}

			my $stats_links = $game->{'availStatLinks'};
			if ( defined $stats_links ) {
				my @keys = keys %$stats_links;
#				print Dumper($stats_links),"\n";
			} else {
				print "no stats links for $game_name\n";
			}
		}
	}
}

#
# TODO: get achievement stats
#

#my $row_count = scalar @rows;
#print "found $row_count rows\n";

if (0) {
	print Dumper($data_out), "\n";
	die "how does it look?";
}

write_storable($steam_storable_filename,$data_out);
write_json($steam_json_filename,$data_out);
